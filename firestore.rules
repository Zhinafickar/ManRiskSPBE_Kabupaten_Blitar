rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // Helper function to check for admin roles
    function isSuperAdmin() {
      return get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'superadmin';
    }
    
    function isAdmin() {
      let role = get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role;
      return role == 'admin' || role == 'superadmin';
    }

    // Allow anyone to read admin tokens for verification purposes.
    // Superadmins can create/delete them.
    match /adminTokens/{tokenId} {
      allow get, list: if true;
      allow write: if isSuperAdmin();
    }
    
    // Users can be created by anyone (during registration).
    // Users can only read/update their own profile.
    // Superadmins can read/update/delete any user profile.
    match /users/{userId} {
      allow read, update: if request.auth != null && request.auth.uid == userId;
      allow create: if request.auth != null;
      // Allow superadmin full access
      allow read, write, delete: if isSuperAdmin();
    }
    
    // Role locks can be created by anyone during registration to prevent duplicates.
    // They can only be deleted by a superadmin (during user management).
    match /roles/{role} {
        allow create: if request.auth != null;
        allow read: if request.auth != null;
        allow delete: if isSuperAdmin();
    }

    // Authenticated users can create/read/update/delete their own surveys.
    // Admins and Superadmins can read all surveys for reporting.
    // Superadmins can delete any survey.
    match /surveys/{surveyId} {
      allow create: if request.auth != null;
      allow read, update, delete: if request.auth != null && resource.data.userId == request.auth.uid;
      allow read, list: if isAdmin();
      allow delete: if isSuperAdmin();
    }
    
    // Authenticated users can create/read/update/delete their own continuity plans.
    // Admins and Superadmins can read all plans for reporting.
    // Superadmins can delete any plan.
    match /continuityPlans/{planId} {
      allow create: if request.auth != null;
      allow read, update, delete: if request.auth != null && resource.data.userId == request.auth.uid;
      allow read, list: if isAdmin();
      allow delete: if isSuperAdmin();
    }

    // Default deny all other reads/writes
    match /{document=**} {
      allow read, write: if false;
    }
  }
}